#!/bin/bash

set -e
set +x
ARGS=("$@")

DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
export DIR="$DIR"

cd "$DIR/config/simplebash" || exit -1
docker-compose rm -f 1>/dev/null 2>&1
set +x

extra_volumes=()

if [[ -n "$2" ]]; then
	if [[ "$1" == "backup" || "$1" == "backup-db" || "$2" == "backup-files" ]]; then
		extra_volumes=("-v $2:$2")
	elif [[ "$1" == "restore" || "$1" == "restore-files" || "$2" == "restore-db" ]]; then
		if [[ -f "$2" ]]; then
			dir=$(dirname "$2")
			extra_volumes+=("-v $dir:$dir")
		fi
		if [[ -f "$3" ]]; then
			dir=$(dirname "$3")
			extra_volumes+=("-v $dir:$dir")
		fi
	fi
fi

command=(docker-compose run)

command+=(--name "odoo_bash_$(uuidgen)")
command+=(-e HOST_ODOO_HOME="$DIR")
command+=(-e ODOO_HOME="$DIR")
if [[ -n "${extra_volumes[*]}" ]]; then
	command+=( "${extra_volumes[@]}" )
fi
command+=(simplebash)
command+=("$DIR/admin/odoo-admin" "${ARGS[@]}")

eval "${command[@]}"
