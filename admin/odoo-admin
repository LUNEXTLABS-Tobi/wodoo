#!/bin/bash
#set -u # treat unset variables as error
# Basic Rules:
# - if a command would stop production run, then ask to continue is done before
# - if in set -e environment and piping commands like cat ... |psql .. then use: pipe=$(mktemp -u); mkfifo $pipe; do.. > $pipe &; do < $pipe
#
# Important Githubs:
#   * https://github.com/docker/compose/issues/2293  -> /usr/local/bin/docker-compose needed
#   * there is a bug: https://github.com/docker/compose/issues/3352  --> using -T
#
# TODO use shift instead of ARGS, ALL_PARAMS - is more bash style
# TODO replace all bash commands to be called within dockerbash
set +x

function dcrun() {
	$dc run -T -e ODOO_HOME=/opt/odoo "$@"
}

function dcexec() {
	$dc exec -T "$@"
}

function startup() {
	local ARGS=("$@")
	# TODO set dir to odoo_home and test
	local $DIR
	DIR=$(realpath "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/..")
	ODOO_HOME=$DIR
	ALL_PARAMS=("${ARGS[@]:1}") # all parameters without command
	export ODOO_MANAGER_STARTED_ONCE=1
	export ODOO_COMPOSE_VERSION="3.3"
	export ODOO_COMPOSE_OPENVPN_DOMAINS_DIR="$DIR/run/openvpn_domains"
	docker_compose_file="$ODOO_HOME/run/docker-compose.yml"
	return 0
}

function get_CUSTOMS_DIR() {
	local CUSTOMS_DIR
	CUSTOMS_DIR=$(
	cd "$ODOO_HOME/admin/module_tools" && \
	python <<-EOF
	import odoo_config
	v = odoo_config.customs_dir()
	print v
	EOF
	)
	echo "$CUSTOMS_DIR"
}

function default_confs() {
	MANAGE="$DIR/odoo"
	local ARGS=("$@")
	export FORCE_CONTINUE=0
	export ODOO_FILES=$DIR/data/odoo.files
	export ODOO_UPDATE_START_NOTIFICATION_TOUCH_FILE=$DIR/run/update_started
	export RUN_POSTGRES=1
	export DB_PORT=5432
	export ALLOW_DIRTY_ODOO=0 # to modify odoo source it may be dirty
	export ADDITIONAL_DOCKER_COMPOSE=""
	export RUN_ODOODEV=0
	export ODOO_HOME=$DIR
	export TELEGRAM_ENABLED=1
	FORCE=0
	echo "${ARGS[*]}" |grep -q '[-]force' && {
		FORCE=1
	}

	if [[ -z "$FORCE_UNVERBOSE" ]]; then
		FORCE_UNVERBOSE=0
	fi
	echo "${ARGS[*]}" |grep -q '[-]unverbose' && {
		FORCE_UNVERBOSE=1
	}
    if [[ -z "$DUMPS_PATH" ]]; then
		export DUMPS_PATH=$ODOO_HOME/dumps
    fi

	if [[ -z "$DEFAULT_USER" ]]; then
		DEFAULT_USER="1000"
	fi

}

function file2env() {
	if [[ ! -f "$1" ]]; then
		return 0
	fi

    # set variables from settings
    while read -r line; do
        # reads KEY1=A GmbH and makes export KEY1="A GmbH" basically
        [[ "$line" == '#*' ]] && continue
        [[ "$line" == '' ]] && continue
        var="${line%=*}"
        value="${line##*=}"
        eval "$var=\"$value\""
    done <"$1"
    export $(cut -d= -f1 "$1")  # export vars now in local variables

	return 0
}

function export_settings() {
	file2env "$DIR/settings"
	file2env "$DIR/settings.override"

	if [[ "$RUN_POSTGRES" == "1" ]]; then
		DB_HOST=postgres
		DB_PORT=5432
		DB_USER=odoo
		DB_PWD=odoo
	fi

	# get odoo version
	ODOO_VERSION=$(
	cd "$ODOO_HOME/admin/module_tools" || exit -1
	python <<-EOF
	import odoo_config
	v = odoo_config.get_version_from_customs("$CUSTOMS")
	print v
	EOF
	)
	export ODOO_VERSION=$ODOO_VERSION

	# set odoo version in settings file for machines
cd "$ODOO_HOME/admin/module_tools" || exit -1
python <<- END
import odoo_config
env = odoo_config.get_env()
env['ODOO_VERSION'] = "$ODOO_VERSION"
env.write()
	END

	if [[ "$FORCE_UNVERBOSE" == "1" ]]; then
		VERBOSE=0
	fi

	[[ "$VERBOSE" == "1" ]] && set -x

    dc="/usr/local/bin/docker-compose -p $PROJECT_NAME -f $docker_compose_file"
	return 0
}

function restore_check() {
	dumpname="$(basename "$1")"
	local force=0

	# asterisk as one word, @ as separate words
	echo "${ALL_PARAMS[*]}" |grep -P -q '[-]force' && {
		force=1
	}

	if [[ ! "${dumpname%.*}" == *"$DBNAME"* ]]; then
		echo "The dump-name \"$dumpname\" should somehow match the current database \"$DBNAME\", which isn't."
		exit -1
	fi

	return 0
}

function exists_db() {
	sql=("select 'database_exists' from pg_database where datname='$DBNAME'")
	if FORCE_UNVERBOSE=1 echo "${sql[0]}"| $MANAGE psql template1 | grep -q 'database_exists'
	then
		echo 'database exists'
	else
		echo 'database does not exist'
	fi

	return 0
}

function remove_postgres_connections() {
	echo "Removing all current connections"

	if [[ "$(exists_db)" != "database does not exist" ]]; then
		SQL=$(cat <<-EOF
			SELECT pg_terminate_backend(pg_stat_activity.pid)
			FROM pg_stat_activity 
			WHERE pg_stat_activity.datname = '$DBNAME' 
			AND pid <> pg_backend_pid(); 
			EOF
			)
		echo "$SQL" | $MANAGE psql template1
	fi

	return 0
}

function do_restore_db_in_docker_container () {
	# remove the postgres volume and reinit

	echo "Restoring dump within docker container postgres"
	dump_file=$(readlink -f "$1")

    if [[ ! -f "$dump_file" ]]; then
        echo "File $dump_file not found!"
        exit -1
    fi

    if [[ "$(dirname "$dump_file")" != "$DUMPS_PATH" ]]; then
        echo "The database to restore must lie in dumps path $DUMPS_PATH"
        exit -1
    fi

	$dc kill
	$dc rm -f || true
	if [[ "$RUN_POSTGRES" == 1 ]]; then
		askcontinue "Removing docker volume postgres-data (irreversible)"
	fi
	VOLUMENAME=${PROJECT_NAME}_postgresdata
	docker volume ls |grep -q "$VOLUMENAME" && docker volume rm "$VOLUMENAME"
	$MANAGE reset-db
    dcrun postgres /restore.sh "$(basename "$dump_file")"
}

function do_restore_db_on_external_postgres () {
	echo "Restoring dump on $DB_HOST"
	dump_file=$1
	echo "Using Host: $DB_HOST, Port: $DB_PORT, User: $DB_USER, ...."
	export PGPASSWORD=$DB_PWD
	local args="-h $DB_HOST -p $DB_PORT -U $DB_USER"
	DROPDB="dropdb $args"
	CREATEDB="createdb $args"
	PGRESTORE="pg_restore $args"

	remove_postgres_connections
	eval "$DROPDB --if-exists $DBNAME" || echo "Failed to drop $DBNAME"
	eval "$CREATEDB $DBNAME"
	pipe="$(mktemp -u)"
	mkfifo "$pipe"
	gunzip -c "$1" > "$pipe" &
	echo "Restoring Database $DBNAME"
	$PGRESTORE -d "$DBNAME" < "$pipe"

	return 0
}

function do_restore_files () {
	# remove the postgres volume and reinit
	tararchive_full_path=$1

    if [[ "$(dirname "$tararchive_full_path")" != "$DUMPS_PATH" ]]; then
        echo "The file to restore must lie in dumps path $DUMPS_PATH"
        exit -1
    fi

	dcrun odoo /bin/restore_files.sh "$(basename "$tararchive_full_path")"
	return 0
}

function askcontinue() {
	if [[ "$1" != "-force" ]]; then
		echo "$1"
	fi
	force=0
	echo "$*" |grep -q '[-]force' && {
		force=1
	}
	if [[ "$force" == "1" || "$FORCE" == "1" || "$FORCE_CONTINUE" == "1" ]]; then
		# display prompt
		echo "Ask continue disabled, continuing..."
	else
		read -r -p "Continue? (Ctrl+C to break)" || {
			exit -1
		}
	fi
	return 0
}

function showhelp() {
    echo Management of odoo instance
    echo
    echo
	echo ./odoo sanity-check
    echo Reinit fresh db:
    echo './odoo reset-db'
    echo
    echo Update:
    echo './odoo update [module]'
    echo 'Just custom modules are updated, never the base modules (e.g. prohibits adding old stock-locations)'
    echo 'Minimal downtime - but there is a downtime, even for phones'
    echo 
    echo "Please call odoo springclean|update|backup|run_standalone|upall|attach_running|rebuild|restart"
	echo ""
	echo "abort-upgrade"
	echo ""
    echo "attach <machine> - attaches to running machine"
	echo ""
    echo "backup <backup-dir> - backup database and/or files to the given location with timestamp; if not directory given, backup to dumps is done "
	echo ""
    echo "backup-db <backup-dir>"
	echo ""
    echo "backup-files <backup-dir>"
	echo ""
    echo "debug <machine-name> - starts /bin/bash for just that machine and connects to it; if machine is down, it is powered up; if it is up, it is restarted; as command an endless bash loop is set"
	echo ""
    echo "dev - starts developing in the odoo container"
	echo ""
    echo "build - no parameter all machines, first parameter machine name and passes other params; e.g. ./odoo build asterisk --no-cache"
	echo ""
	echo "link - links all modules into ./links"
	echo ""
    echo "telegram-setup- helps creating a permanent chatid"
	echo ""
    echo "kill - kills running machines"
	echo ""
    echo "logs - show log output; use parameter to specify machine"
	echo ""
    echo "logall - shows log til now; use parameter to specify machine"

	echo ""
	echo "---------------------------------------------------------------"
	echo "OVPN"
	echo ""
    echo 'make-CA - recreates CA caution! for asterisk domain e.g. provide parameter "asterisk"'
    echo "make-phone-CA - recreates CA caution!"
    echo "show-openvpn-ciphers - lists the available ciphers"
    echo "enter-VPN <domain> - starts machine and you have some tools like nmap"
	echo ""
	echo "---------------------------------------------------------------"
	echo ""
    echo "springclean - remove dead containers, untagged images, delete unwanted volums"
	echo ""
    echo "rm - command"
	echo ""
	echo "compose - just build the big docker-compose file"
	echo ""
    echo "rebuild - rebuilds docker-machines - data not deleted"
	echo ""
    echo "restart - restarts docker-machine(s) - parameter name"
	echo ""
    echo "restore <filepathdb> <filepath_tarfiles> [-force] - restores the given dump as odoo database"
	echo ""
    echo "restore-dev-db - Restores database dump regularly and then applies scripts to modify it, so it can be used for development (adapting mailserver, disable cronjobs)"
	echo ""
    echo "runbash <machine name> - starts bash in NOT RUNNING container (a separate one)"
	echo ""
    echo "setup-startup makes skript in /etc/init/${CUSTOMS}"
	echo ""
    echo "stop - like docker-compose stop"
	echo ""
    echo "quickpull - fetch latest source, oeln - good for mako templates"
	echo ""
	echo "turn-into-dev - applies scripts to make the database a dev database"
	echo ""
    echo "update <machine name>- fetch latest source code of modules and run update of just custom modules; machines are restarted after that"
	echo ""
    echo "up - starts all machines equivalent to service <service> start "
	echo ""
	echo "remove-web-assets - if odoo-web interface is broken (css, js) then purging the web-assets helps; they are recreated on odoo restart"
	echo ""
	echo "fix-permissions - sets user 1000 for odoo and odoo_files"
	echo ""
	echo "show-install-state "
	echo ""
	echo "make-customs"
    echo
	echo "patch - run without arguments for help"
	echo ""
	echo "version - run without arguments for help"
	echo ""
	echo "lsyncd - displays the command to execute lsyncd"
}

if [ -z "$1" ]; then
    showhelp
    exit -1
fi

function prepare_filesystem() {
    mkdir -p "$DIR"/run/{config,sqlscripts,debug,nginx_confs}
	sudo -E chown $DEFAULT_USER:$DEFAULT_USER -R "$DIR"/run
	return 0
}

function prepare_yml_files_from_template_files() {
    # replace params in configuration file
    # replace variables in docker-compose;
    cd "$DIR"

	if [[ "$ODOO_MANAGER_STARTED_ONCE" != "1" ]]; then
		echo "CUSTOMS: $CUSTOMS"
		echo "DB: $DBNAME"
		echo "VERSION: $ODOO_VERSION"
		echo "FILES: $ODOO_FILES"
	fi
	CUSTOMS_DIR=$(get_CUSTOMS_DIR)

	# python: find all configuration files from machines folder; extract sort 
	# by manage-sort flag and put file into run directory
	# only if RUN_parentpath like RUN_ODOO is <> 0 include the machine
	#
	# - also replace all environment variables
	PATTERN='docker-compose*.yml'
	rm "$DIR/run/$PATTERN" > /dev/null 2>&1 || true

	declare -a all_dirs
	all_dirs[0]="machines"
	if [[ -d "$CUSTOMS_DIR/machines" ]]; then
		all_dirs[1]="$CUSTOMS_DIR/machines"
	fi
	ALL_CONFIG_FILES=$(cd "$DIR"; find "${all_dirs[@]}" -name "$PATTERN")

	# append openvpnconfig from domain preparation of vpn domains 
	ALL_CONFIG_FILES=$(echo "$ALL_CONFIG_FILES"; find "$ODOO_COMPOSE_OPENVPN_DOMAINS_DIR" -type f -name "$PATTERN")


	# Make all config files to absolutepath
	ALL_CONFIG_FILES=$(echo "$ALL_CONFIG_FILES" | while read -r f; do readlink -e "$f"; done)

	python ./admin/prepare_dockercompose_files.py ./run/docker-compose.yml "$ALL_CONFIG_FILES"

	return 0
}


function do_command() {
    case $1 in
	abort-upgrade)
		SQL=$(cat <<-EOF
			UPDATE ir_module_module SET state = 'installed' WHERE state = 'to upgrade';
			UPDATE ir_module_module SET state = 'uninstalled' WHERE state = 'to install';
			EOF
			)
		echo "$SQL" | $MANAGE psql "$DBNAME"

		;;
    setup-startup)
        PATH=$DIR
		exit 5

        if [[ -f /sbin/initctl ]]; then
            # ubuntu 14.04 upstart
            file=/etc/init/${CUSTOMS}_odoo.conf

            echo "Setting up upstart script in $file"
            /bin/cp "$DIR/config/upstart" "$file"
            /bin/sed -i -e "s/\${DCPREFIX}/$DCPREFIX/" -e "s/\${DCPREFIX}/$DCPREFIX/" "$file"
            /bin/sed -i -e "s|\${PATH}|$PATH|" -e "s|\${PATH}|$PATH|" "$file"
            /bin/sed -i -e "s|\${CUSTOMS}|$CUSTOMS|" -e "s|\${CUSTOMS}|$CUSTOMS|" "$file"
            /sbin/initctl reload-configuration
        else
            echo "Setting up systemd script for startup"
            servicename=${CUSTOMS}_odoo.service
            file=/lib/systemd/system/$servicename

            echo "Setting up upstart script in $file"
            /bin/cp "$DIR/config/systemd" "$file"
            /bin/sed -i -e "s/\${DCPREFIX}/$DCPREFIX/" -e "s/\${DCPREFIX}/$DCPREFIX/" "$file"
            /bin/sed -i -e "s|\${PATH}|$PATH|" -e "s|\${PATH}|$PATH|" "$file"
            /bin/sed -i -e "s|\${CUSTOMS}|$CUSTOMS|" -e "s|\${CUSTOMS}|$CUSTOMS|" "$file"

            /bin/systemctl disable "$servicename"
            /bin/rm "/etc/systemd/system/$servicename"
            /bin/rm "lib/systemd/system/$servicename"
            /bin/systemctl daemon-reload
            /bin/systemctl reset-failed
            /bin/systemctl enable "$servicename"
            /bin/systemctl start "$servicename"
        fi
        ;;
    exec)
        $dc exec "${ALL_PARAMS[@]}"
        ;;
    backup-db)
        if [[ -n "$2" ]]; then
            BACKUPDIR=$2
			
        else
            BACKUPDIR=$DIR/dumps
        fi
        filename=$DBNAME.$(date "+%Y-%m-%d_%H%M%S").dump.gz
        filepath=$BACKUPDIR/$filename
        LINKPATH=$DIR/dumps/latest_dump
		if [[ "$RUN_POSTGRES" == "1" ]]; then
			$dc up -d postgres odoo
			dcexec postgres /backup.sh
			mv "$DIR/dumps/$DBNAME.gz" "$filepath"
		else
			pg_dump -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -Z0 -Fc "$DBNAME" | pigz --rsyncable > "$filepath"
		fi
        /bin/rm "$LINKPATH" || true
        ln -s "$filepath" "$LINKPATH"
        md5sum "$filepath"
        echo "Dumped to $filepath"
		$MANAGE telegram-send "Database Backup $DBNAME done to $filepath"
        ;;
	lsyncd)
		echo 
		echo 
		echo Use for syncing remote machine:
		echo
		echo
		echo
		for line in $(cd "$DIR"; find "./config/lsyncd/" -not -path '*/\.*' -not -path '*/' -maxdepth 1|tr '\n' ' or '); do
			echo "sudo lsyncd -nodaemon $line"
		done
		echo
		echo
		echo
		;;
    backup-files)
        if [[ -n "$2" ]]; then
            BACKUPDIR=$2
        else
            BACKUPDIR=$DIR/dumps
        fi
        BACKUP_FILENAME=$CUSTOMS.files.tar.gz
        BACKUP_FILEPATH=$BACKUPDIR/$BACKUP_FILENAME

		dcrun odoo /backup_files.sh
        [[ -f $BACKUP_FILEPATH ]] && rm -Rf "$BACKUP_FILEPATH"
        mv "$DIR/dumps/odoofiles.tar" "$BACKUP_FILEPATH"

        echo "Backup files done to $BACKUP_FILEPATH"
        ;;

    backup)
		$MANAGE backup-db "${ALL_PARAMS[@]}"
		$MANAGE backup-files "${ALL_PARAMS[@]}"
        ;;
    reset-db)
		echo "$*" |grep -q '[-]force' || {
            askcontinue "Deletes database $DBNAME!"
		}
		if [[ "$RUN_POSTGRES" != "1" ]]; then
			echo "Postgres container is disabled; cannot reset external database"
			exit -1
		fi
        echo "Stopping all services and creating new database"
        echo "After creation the database container is stopped. You have to start the system up then."
        $dc kill
        dcrun -e INIT=1 postgres /entrypoint2.sh
        echo
        echo 
        echo
        echo "Database initialized. You have to restart now."

        ;;

	restore-files)
		set -e
        if [[ -z "$2" ]]; then
			echo "Please provide the tar file-name."
			exit -1
        fi
		echo 'Extracting files...'
		do_restore_files "$2"
		;;

	restore-db)
		set -e
		dumpfile="$2"
		restore_check "$dumpfile"

		echo "$*" |grep -q '[-]force' || {
			askcontinue "Deletes database $DBNAME!"
		}

		if [[ "$RUN_POSTGRES" == "1" ]]; then
			do_restore_db_in_docker_container "$dumpfile"
		else
			askcontinue "Trying to restore database on remote database. Please make sure, that the user $DB_USER has enough privileges for that."
			do_restore_db_on_external_postgres "$dumpfile"
		fi
		set_db_ownership
		$MANAGE telegram-send "Database Restore $DBNAME done."

		;;
	set_db_ownership)
		set_db_ownership
		;;

    restore)

        if [[ ! -f $2 ]]; then
            echo "File $2 not found!"
            exit -1
        fi
        if [[ -n "$3" && ! -f $3 ]]; then
            echo "File $3 not found!"
            exit -1
        fi

		dumpfile=$2
		tarfiles=$3

		$MANAGE restore-db "$dumpfile"
		
		if [[ "$tarfiles" == "[-]force" ]]; then
			tarfiles=""
		fi

        if [[ -n "$tarfiles" ]]; then
			$MANAGE restore-files $tarfiles
        fi

		$MANAGE fix-permissions

        echo "Restart systems by $MANAGE restart"
        ;;
    restore-dev-db)
		if [[ "$ALLOW_RESTORE_DEV" ]]; then
			echo "ALLOW_RESTORE_DEV must be explicitly allowed."
			exit -1
		fi
        echo "Restores dump to locally installed postgres and executes to scripts to adapt user passwords, mailservers and cronjobs"
		$MANAGE restore-db "${ALL_PARAMS[@]}"
		$MANAGE turn-into-dev "${ALL_PARAMS[@]}"

        ;;
	turn-into-dev)
		if [[ "$DEVMODE" != "1" ]]; then
			echo "When applying this sql scripts, the database is not usable anymore for production environments. "
			echo "Please set DEVMODE=1 to allow this"
			exit -1
		fi
        SQLFILE=machines/postgres/turndb2dev.sql
		$MANAGE psql "$DBNAME" < $SQLFILE
		
		;;
	psql)
		# gets sql query from pipe
		# check if there is a pipe argument
		local query=""
		if [[ ! -t 0 ]]; then  # checks if there is pipe data https://unix.stackexchange.com/questions/33049/check-if-pipe-is-empty-and-run-a-command-on-the-data-if-it-isnt
			query="$(cat /dev/stdin)"
		fi	

		if [[ "$RUN_POSTGRES" == "1" ]]; then
			$dc up -d postgres odoo
			$MANAGE wait_for_container_postgres
            SQLFILE="$DIR/run/sqlscripts/script.sql"
            echo "$query" | tee "$SQLFILE"

            dcexec postgres gosu postgres psql "${ALL_PARAMS[*]}" -U "$DB_USER" -f "/opt/sqlscripts/$(basename "$SQLFILE")"
            rm "$SQLFILE"
		else
			export PGPASSWORD=$DB_PWD
			echo "$query" | psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -w "${ALL_PARAMS[@]}"
		fi 
		;;

    springclean)
        docker system prune

        echo removing dead containers
		docker ps -a -q | while read -r id; do
			docker rm "$id"
		done

        echo Remove untagged images
        docker images | grep "<none>" | awk '{ print "docker rmi " $3 }' | bash

        echo "delete unwanted volumes (can pass -dry-run)"
		docker images -q -f='dangling=true' | while read -r id; do
			docker rmi "$id"
		done
        ;;
    up)
		set_db_ownership
        $dc up "${ALL_PARAMS[@]}"
        ;;
    debug)
		# puts endless loop into container command and then attaches to it;
		# by this, name resolution to the container still works
        if [[ -z "$2" ]]; then
            echo "Please give machine name as second parameter e.g. postgres, odoo"
            exit -1
        fi
		set_db_ownership
        echo "Current machine $2 is dropped and restartet with service ports in bash. Usually you have to type /debug.sh then."
        askcontinue
        # shutdown current machine and start via run and port-mappings the replacement machine
        $dc kill "$2"
        cd "$DIR"
		DEBUGGING_COMPOSER=$DIR/run/debugging.yml
		cp "$DIR/config/debugging/template.yml" "$DEBUGGING_COMPOSER"
		sed -i -e "s/\${DCPREFIX}/$DCPREFIX/" -e "s/\${NAME}/$2/" "$DEBUGGING_COMPOSER"
		dc="$dc -f $DEBUGGING_COMPOSER"  # command now has while loop

        #execute self
		$dc up -d "$2"
		$MANAGE attach "$2"

        ;;
    attach)
        if [[ -z "$2" ]]; then
            echo "Please give machine name as second parameter e.g. postgres, odoo"
            exit -1
        fi
		display_machine_tips "$2"
        $dc exec "$2" bash
        ;;
    run)
		set_db_ownership
        $dc run "${ALL_PARAMS[@]}"
		;;
    runbash)
		set_db_ownership
        if [[ -z "$2" ]]; then
            echo "Please give machine name as second parameter e.g. postgres, odoo"
            exit -1
        fi
		display_machine_tips "$2"
        $dc run "$2" bash
        ;;
    rebuild)
        cd "$DIR"
        $dc build --no-cache "${ALL_PARAMS[@]}"
        ;;
    build)
        cd "$DIR"
        $dc build "${ALL_PARAMS[@]}"
        ;;
    kill)
        cd "$DIR"
        eval "$dc kill $2 $3 $4 $5 $6 $7 $8 $9"
        ;;
    stop)
        cd "$DIR"
        eval "$dc stop $2 $3 $4"
        ;;
    logsn)
        cd "$DIR"
        eval "$dc logs --tail=$2 -f -t $3 $4"
        ;;
    logs)
        cd "$DIR"
        lines="${ARGS[-1]}"
        if [[ -n ${lines//[0-9]/} ]]; then
            lines="5000"
        else
            echo "Showing last $lines lines"
        fi
        eval "$dc logs --tail=$lines -f -t $2 "
        ;;
    logall)
        cd "$DIR"
        eval "$dc logs -f -t $2 $3"
        ;;
    rm)
        cd "$DIR"
        $dc rm "${ALL_PARAMS[@]}"
        ;;
    restart)
        cd "$DIR"
        eval "$dc kill $2"
        eval "$dc rm -f $2"
        eval "$dc create --force-recreate $2"
        eval "$dc up -d $2"
        ;;

	dev)
		$MANAGE kill
		$MANAGE rm -f
		$MANAGE build
		$MANAGE up -d
		$MANAGE attach odoo
		;;

	telegram-setup)
		if [[ "$TELEGRAM_ENABLED" == "1" ]]; then
			export DIR="$DIR"
			cd "$DIR"/config/telegrambot
			docker-compose run telegrambot /setup.sh
		fi
		;;
	telegram-send)
		if [[ "$TELEGRAM_ENABLED" == "1" ]]; then
			export DIR="$DIR"
			cd "$DIR"/config/telegrambot
			docker-compose run telegrambot /send.py "$2"
		fi
		;;
	fix-permissions)
		if [[ -d "$ODOO_FILES" && -n "$ODOO_FILES" ]]; then
			chown 1000 -R "$ODOO_FILES"
		fi
		CUSTOMS_DIR=$(get_CUSTOMS_DIR)
		if [[ -d "$CUSTOMS_DIR" && -n "$CUSTOMS_DIR" ]]; then
			chown 1000 -R "$CUSTOMS_DIR"
		fi

		;;
    update)

		$MANAGE abort-upgrade

        echo "Run module update"
		if [[ -n "$ODOO_UPDATE_START_NOTIFICATION_TOUCH_FILE" ]]; then
			date +%s > "$ODOO_UPDATE_START_NOTIFICATION_TOUCH_FILE"
		fi
		# running duplicate updates is really a problem;
        $dc kill 
        $dc rm -f
        $dc create --force-recreate
        if [[ "$RUN_POSTGRES" == "1" ]]; then
			$dc up -d postgres
			$MANAGE wait_for_container_postgres
        fi

        dcrun odoo_update /update_modules.sh "$2" || true
		$MANAGE show-install-state || exit 34

        $dc up -d
        $dc up -d
        $dc up -d
        $dc restart nginx

        df -h / # case: after update disk / was full
		if [[ -n "$ODOO_UPDATE_START_NOTIFICATION_TOUCH_FILE" ]]; then
			echo '0' > "$ODOO_UPDATE_START_NOTIFICATION_TOUCH_FILE"
		fi
		$MANAGE telegram-send "Update done" # &> /dev/null

       ;;

	show-install-state)
		SQL=$(cat <<-EOF
			SELECT name, state from ir_module_module where state not in ('installed', 'uninstalled');
			EOF
			)
		echo "Displaying dangling modules:"
		echo "$SQL" | $MANAGE psql "$DBNAME"

		has_dangling=$(echo "$SQL" | $MANAGE psql "$DBNAME" | grep "(0 rows)")
		if [[ -z "$has_dangling" ]]; then
			echo "Dangling modules detected - please fix installation problems and retry!"
			exit -32
		fi

		;;

    show-openvpn-ciphers)
	   dcrun default_ovpn_minimal /usr/sbin/openvpn --show-ciphers
	   ;;

	enter-VPN)
		echo "Starting a machine, so you have access to the VPN Network"
		echo "You can scan for live hosts and check if the network is up."
		echo
		echo "Samples: "
		echo "------------"
		echo "ifconfig"
		echo "nmap -sP 192.168.2.1/24"
		echo
		domain="$2"
		$MANAGE up -d "${domain}_ovpn_server"
		$MANAGE run "${domain}_ovpn_server_client" run_ovpn_server_as_client.sh 
		;;
    make-phone-CA)
		$MANAGE make-CA asterisk
		;;
	force-ovpn-domain)
		# checks for parameter "$domain"
		domain=$2
		if [[ -z "$domain" ]]; then
			echo "OVPN Domain missing"
			exit -1
		fi
		;;
    make-CA)
        echo '!!!!!!!!!!!!!!!!!!'
        echo '!!!!!!!!!!!!!!!!!!'
        echo '!!!!!!!!!!!!!!!!!!'
        echo
        echo
        echo "Extreme Caution!"
        echo 
        echo '!!!!!!!!!!!!!!!!!!'
        echo '!!!!!!!!!!!!!!!!!!'
        echo '!!!!!!!!!!!!!!!!!!'
		domain=$2
		set -e
		$MANAGE force-ovpn-domain "$domain"

        askcontinue -force
        export dc=$dc
        $dc kill "${domain}_ovpn_manage"
		# backup old data before

		mkdir -p "$DIR/data/ovpn_backup"
		cd "$DIR/data/ovpn_backup"
		if [[ -d $domain ]]; then
			tar cfz "$domain-$(date +%Y%m%d-%H%M%S).tar.gz" "$DIR/data/ovpn/$domain"
		fi

        dcrun "${domain}_ovpn_manage" clean_all.sh
        dcrun "${domain}_ovpn_manage" make_ca.sh
        dcrun "${domain}_ovpn_manage" make_server_keys.sh
        dcrun "${domain}_ovpn_manage" make_default_keys.sh
        dcrun "${domain}_ovpn_manage" pack_server_conf.sh
        ;;
    export-i18n)
        LANG=$2
        MODULES=$3
        if [[ -z "$MODULES" ]]; then
            echo "Please define at least one module"
            exit -1
        fi
        dcrun odoo /export_i18n.sh "$LANG" "$MODULES"
        # file now is in $DIR/run/i18n/export.po
        ;;
    import-i18n)
        dcrun odoo /import_i18n.sh "${ALL_PARAMS[@]}"
        ;;
	remove-web-assets)
		askcontinue
		dcrun odoo bash -c "cd ./admin/module_tools; python -c'from module_tools import remove_webassets; remove_webassets()'"
		echo
		echo
		echo "Please login as admin, so that assets are recreated."
		echo
		echo
		echo
		;;
	sanity_check)
		sanity_check
		;;
	make_customs)
		set -e
		askcontinue
		$MANAGE kill
		CUSTOMS=$2
		VERSION=$3
		"$ODOO_HOME/admin/module_tools/make_customs" "$2" "$3"
		cd "$ODOO_HOME/admin/module_tools"
		python <<- END
		import odoo_config
		odoo_config.set_customs("$2")
		END

		cd "$ODOO_HOME/customs/$2"
		git submodule add https://github.com/odoo/odoo odoo
		cd odoo
		git checkout "$VERSION"
		"$ODOO_HOME/admin/OCA-all"
		"$ODOO_HOME/admin/odoo-submodule tools,web_modulesroduct_modules,calendar_ics"
		"$ODOO_HOME/$MANAGE" up -d
		chromium-browser http://localhost

		;;
	OCA)
		"$ODOO_HOME/admin/OCA" "${ALL_PARAMS[@]}"
		;;
	compose)
		echo "Built the docker-compose file."
		;;
	test)
		echo 'reached the command area'
		echo "DIR is: $DIR"
		echo "CUSTOMS is: $CUSTOMS"
		;;
	test_make_error)
		echo "now throwing exit code"
		exit -123
		;;
	progress)
		SQL=$(cat <<-EOF
			select state, count(*) from ir_module_module group by state;
			EOF
			)
		echo "$SQL" | $MANAGE psql "$DBNAME"

		;;
	prepare)
		echo "All configurations prepared."
		;;
	link)
		python "$ODOO_HOME/admin/link_modules"
	
		;;

	patch)
		cmd=("$ODOO_HOME/admin/odoo-patch")
		cmd+=("${ALL_PARAMS[@]}")
		eval "${cmd[@]@Q}"
		;;
	wait_for_port)
		started=$(date +"%s")
		while ! nc -q 1 "$2" "$3" </dev/null; do 
			sleep 1;
			now=$(date +"%s")
			(( elapsed = ("$now" - "$started") % 5))
			if [[ "$elapsed" == "0" ]]; then
				echo "Waiting for $2 on port $3..."
			fi

			if [[ "$elapsed" -gt 20 ]]; then
				echo "Waiting too long for $2 on port $3. Exiting with error-code."
				exit 20
			fi
			
		done
		;;
	wait_for_container_postgres)
		$MANAGE wait_for_port postgres 5432
		;;

	dirty)
		cmd=("$ODOO_HOME/admin/module_tools/odoo-versioning")
		cmd+=("dirty")
		eval "${cmd[@]@Q}"
		;;
	fix-src-rights)
		CUSTOMS_DIR=$(get_CUSTOMS_DIR)
		chown "$DEFAULT_USER:$DEFAULT_USER" -R "$CUSTOMS_DIR"
		;;
	new-ticket)
		cmd=("$ODOO_HOME/admin/module_tools/odoo-versioning")
		cmd+=("new-ticket")
		cmd+=("$2")
		eval "${cmd[@]@Q}"
		$MANAGE fix-src-rights
		;;
	merge)
		cmd=("$ODOO_HOME/admin/module_tools/odoo-versioning")
		cmd+=("merge")
		cmd+=("$2")
		eval "${cmd[@]@Q}"
		# fix source rights
		$MANAGE fix-src-rights
		;;
    *)
        echo "Invalid option $1"
        exit -1
        ;;
    esac
}


function cleanup() {

    if [[ -f config/docker-compose.yml ]]; then
        /bin/rm config/docker-compose.yml || true
    fi

	remove_temp_directories

}

function try_to_set_owner() {
	OWNER=$1
	dir=$2
	if [[ -d "$dir" && "$(stat -c "%u" "$dir")" != "$OWNER" ]]; then
		echo "Trying to set correct permissions on restore directory"
		chown "$OWNER" "$dir"
		if [[ "$?" != 0 ]]; then
			sudo chown "$OWNER" "$dir"
		fi
	fi
}

function sanity_check() {

	grep -q "DEFAULT_USER=" < "$ODOO_HOME"/settings || {
		echo "Please define DEFAULT_USER=1000 at least in settings."
		exit -1
	}

    if [[ ( "$RUN_POSTGRES" == "1" || -z "$RUN_POSTGRES" ) && "$DB_HOST" != 'postgres' ]]; then
        echo "You are using the docker postgres container, but you do not have the DB_HOST set to use it."
        echo "Either configure DB_HOST to point to the docker container or turn it off by: "
        echo 
        echo "RUN_POSTGRES=0"
        exit -1
    fi

    if [[ "$RUN_POSTGRES" == "1"  ]]; then
		RESTORE_DIR="$DIR/run/restore"
		if [[ -d "$RESTORE_DIR" ]]; then
			try_to_set_owner "1000" "$RESTORE_DIR"
		fi
	fi

	if [[ -d $ODOO_FILES ]]; then
		# checking directory permissions of session files and filestorage
		try_to_set_owner "1000" "$ODOO_FILES"
	fi

	# make sure the odoo_debug.txt exists; otherwise directory is created
	if [[ ! -f "$DIR/run/odoo_debug.txt" ]]; then
		touch "$DIR/run/odoo_debug.txt"
	fi

	if [[ -z "$ODOO_MODULE_UPDATE_DELETE_QWEB" ]]; then
		echo "Please define ODOO_MODULE_UPDATE_DELETE_QWEB"
		echo "Whenever modules are updated, then the qweb views are deleted."
		echo
		echo "Typical use for development environment."
		echo
		exit -1
	fi

	if [[ -z "$ODOO_MODULE_UPDATE_RUN_TESTS" ]]; then
		echo "Please define wether to run tests on module updates by setting ODOO_MODULE_UPDATE_RUN_TESTS"
		echo
		exit -1
	fi

	if [[ -z "$ODOO_CHANGE_POSTGRES_OWNER_TO_ODOO" ]]; then
		echo "Please define ODOO_CHANGE_POSTGRES_OWNER_TO_ODOO"
		echo In development environments it is safe to set ownership, so
		echo that accidently accessing the db fails
		echo
		exit -1
	fi
}

function set_db_ownership() {
	# in development environments it is safe to set ownership, so
	# that accidently accessing the db fails
	if [[ -n "$ODOO_CHANGE_POSTGRES_OWNER_TO_ODOO" ]]; then
		if [[ "$RUN_POSTGRES" == "1" ]]; then
			$dc up -d postgres
		fi
		dcrun odoo bash -c "cd ./admin/module_tools; python -c'from module_tools import set_ownership_exclusive; set_ownership_exclusive()'"
	fi
}

function display_machine_tips() {
	cd "$DIR"
	tipfile=$(find "machines" -name 'tips.txt' | grep -P "\/$1\/" | while read -r file; do
		echo "$DIR/$file"
	done)
	if [[ -f "$tipfile" ]]; then
		echo 
		echo Please note:
		echo ---------------
		echo
		cat "$tipfile"
		echo 
		echo
	fi

	return 0
}

function update_openvpn_domains() {

	# searches for config files of openvpn and then copies the 
	# template openvpn docker compose to run; 
	# attaches the docker-compose to $dc then

	[[ -d "${ODOO_COMPOSE_OPENVPN_DOMAINS_DIR:?}" ]] && rm -Rf "$ODOO_COMPOSE_OPENVPN_DOMAINS_DIR"

	find "$DIR/machines" -name 'ovpn-domain.conf' | while read -r file; do
		local parent
		parent="$ODOO_COMPOSE_OPENVPN_DOMAINS_DIR/$(basename "$(dirname "$file")")"
		mkdir -p "$parent"
		OPENVPN_CONFIG_FILE="$parent/docker-compose.run_openvpn.yml"
		python "$DIR/machines/openvpn/bin/prepare_domain_for_manage.py" "${file}" "$DIR" "$OPENVPN_CONFIG_FILE"
	done

	return 0

}

function awk() {
	AWK=$(which awk)
	command "${AWK:-awk}" "$@";
	return 0
}

function reset_nginx_configs() {
	local nginx_configs_dir
	local paths_dir

	nginx_configs_dir="$ODOO_HOME/run/nginx_confs"
	rm "${nginx_configs_dir:?}"/* -Rf 1>/dev/null 2>&1 || true

	paths_dir="$ODOO_HOME/run/nginx_paths"
	if [[ -d "$paths_dir" ]]; then
		rm "${paths_dir:?}"/\* -Rf 1>/dev/null 2>&1 || true
	else
	    mkdir -p "$paths_dir"
	fi
}

function setup_odoo_instances() {
	local nginx_configs_dir
	local name
	local subdomain_path
	local config_path

	nginx_configs_dir=$ODOO_HOME/run/nginx_confs
	if [[ -f "$DIR/run/odoo_instances" ]]; then
		rm "$nginx_configs_dir"/odoo_instance_* 1>/dev/null 2>&1 || true

		while read -r line; do
			name="$(echo "$line"| awk '{print $1}')"
			subdomain_path="$(echo "$line"| awk '{print $2}')"
			config_path="$nginx_configs_dir/odoo_instance_${name}.conf"
			cp "$ODOO_HOME/machines/nginx/nginx_${ODOO_VERSION}.conf" "$config_path"
			sed -i "s|__HTTP_HOST__|$subdomain_path|g" "$config_path"
			# treat the name of the instance as domain; is used in setup_nginx_paths, too
			sed -i "s|__PATH_DIR__|$name|g" "$config_path"

			# adapt the one yml file and duplicate the odoo service there;
			# removing any ports
			python <<EOF
import yaml, os
from copy import deepcopy
with open("$docker_compose_file") as f:
	j = yaml.load(f.read())
odoo = deepcopy(j['services']['odoo'])
if 'ports' in odoo:
	del odoo['ports']
odoo['container_name'] = '_'.join([os.environ['DCPREFIX'], "odoo", "$name"])
j['services']['odoo_{}'.format("$name")] = odoo
with open("$docker_compose_file", 'w') as f:
	f.write(yaml.dump(j, default_flow_style=False))
EOF

		done <"$DIR/run/odoo_instances"
	fi
	return 0
	
}

function remove_temp_directories() {
	cd "$DIR" || exit -1
	find . -maxdepth 1 -type d|grep -E 'tmp......' | xargs sudo rm {} -Rf \;
}

function setup_nginx_paths() {
	URLPATH_DIR="$ODOO_HOME/run/nginx_paths"

	find "$ODOO_HOME/machines" -name 'nginx.path' | while read -r f; do
		content=$(
			envsubst < "$f"
		)
		while read -r line; do
			local URLPATH
			local MACHINE
			local PORT

			URLPATH=$(echo "$line" | awk '{print $1}')
			MACHINE=$(echo "$line" | awk '{print $2}')
			PORT=$(echo "$line" | awk '{print $3}')

			if [[ -z "$PORT" || -z "$MACHINE" ]]; then
				echo "Invalid nginx urlpath: $f"
				exit -1
			fi

			"$DIR/machines/nginx/add_nginx_path.sh" "$URLPATH" "$MACHINE" "$PORT" "$URLPATH_DIR" 

			# set subdomains also for other odoo instances
			if [[ -f "$DIR/run/odoo_instances" && "$MACHINE" == "odoo" ]]; then
				while read -r line; do
					name="$(echo "$line"| awk '{print $1}')"
					hostname="$(echo "$line"| awk '{print $2}')"
					container_name="odoo_$name"  # e.g. odoo
					"$DIR/machines/nginx/add_nginx_path.sh" "/" "$container_name" "$PORT" "$URLPATH_DIR" "" "$hostname"

				done <"$DIR/run/odoo_instances"
			fi
		done <<< "$content"
	done
	return 0
}


function remember_customs_and_cry_if_changed() {
	# if customs changed, then restart is required
	if [[ "$ODOO_MANAGER_STARTED_ONCE" == "1" ]]; then
		return 0
	fi

	current_customs=$(cd "$DIR"; dcexec odoo env | grep "^CUSTOMS=" || echo "")
	current_customs=${current_customs/CUSTOMS=/}

	if [[ -n "$current_customs" && "$current_customs" != "$CUSTOMS" ]]; then
		echo "Customs changed - you need to restart and/or rebuild!"
		sleep 3
		"$MANAGE" kill
	fi

	return 0
}

function main() {
	set -e
	local ARGS=("$@")
	startup "${ARGS[@]}"
	if [[ "${ARGS[0]}" == "tool" ]]; then

		python "$DIR/admin/module_tools/tool.py" "${ALL_PARAMS[@]@Q}"

	else

		default_confs "${ARGS[@]}"
		export_settings
		remember_customs_and_cry_if_changed
		case $1 in
			up|build|compose)
				set -e
				remove_temp_directories
				prepare_filesystem
				update_openvpn_domains 
				prepare_yml_files_from_template_files
				reset_nginx_configs
				setup_odoo_instances
				setup_nginx_paths
				;;

			*)
			;;
		esac
		sanity_check

		cd "$ODOO_HOME"
		do_command "${ARGS[@]}"
		cleanup
	fi
}


ARGS=("$@")
main "${ARGS[@]}"
